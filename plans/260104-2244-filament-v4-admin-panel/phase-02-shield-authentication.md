# Phase 02: Shield Authentication Setup

## Context Links
- Parent: [plan.md](./plan.md)
- Depends on: [Phase 01](./phase-01-installation-configuration.md)
- Docs: [Filament Shield Plugin](https://filamentphp.com/plugins/bezhansalleh-shield)

## Overview
- **Priority**: P1 (Blocking)
- **Effort**: 1h
- **Status**: Pending
- **Description**: Install and configure Filament Shield for granular role-based access control

## Key Insights
- Shield integrates with existing spatie/laravel-permission
- Auto-generates permissions for each Filament resource
- Supports super_admin role for full access
- Provides UI for managing roles/permissions

## Requirements

### Functional
- Shield plugin integrated with admin panel
- Super admin role with full access
- Auto-generated permissions per resource
- Role management UI in admin

### Non-Functional
- Compatible with existing HasRoles trait on User model
- No duplicate permission tables (reuse existing)

## Architecture

```
app/
├── Filament/
│   └── Resources/
│       └── Shield/
│           └── RoleResource.php      # Auto-generated by Shield
└── Domain/User/Models/User.php       # Already has HasRoles trait

config/
└── filament-shield.php               # Shield configuration
```

## Related Code Files

| Action | File | Description |
|--------|------|-------------|
| MODIFY | `app/Providers/Filament/AdminPanelProvider.php` | Register Shield plugin |
| MODIFY | `app/Domain/User/Models/User.php` | Add HasPanelShield trait |
| CREATE | `config/filament-shield.php` | Shield configuration |
| MODIFY | `database/seeders/DatabaseSeeder.php` | Seed super admin |

## Implementation Steps

### Step 1: Install Shield Plugin
```bash
composer require bezhansalleh/filament-shield:"^4.0"
```

### Step 2: Publish Configuration
```bash
php artisan vendor:publish --tag=filament-shield-config
```

### Step 3: Configure Shield
Edit `config/filament-shield.php`:

```php
<?php

return [
    'shield_resource' => [
        'should_register_navigation' => true,
        'slug' => 'shield/roles',
        'navigation_sort' => -1,
        'navigation_badge' => true,
        'navigation_group' => true,
        'is_globally_searchable' => false,
        'show_model_path' => true,
    ],

    'auth_provider_model' => [
        'fqcn' => \App\Domain\User\Models\User::class,
    ],

    'super_admin' => [
        'enabled' => true,
        'name' => 'super_admin',
        'define_via_gate' => true,
        'intercept_gate' => 'before',
    ],

    // Use existing permission/role tables from spatie
    'permission_prefixes' => [
        'resource' => [
            'view',
            'view_any',
            'create',
            'update',
            'delete',
            'delete_any',
            'force_delete',
            'force_delete_any',
            'restore',
            'restore_any',
            'reorder',
        ],
        'page' => 'page',
        'widget' => 'widget',
    ],

    'entities' => [
        'pages' => true,
        'widgets' => true,
        'resources' => true,
    ],

    'generator' => [
        'option' => 'policies_and_permissions',
    ],

    'exclude' => [
        'enabled' => true,
        'pages' => [],
        'widgets' => [],
        'resources' => [],
    ],
];
```

### Step 4: Register Shield in AdminPanelProvider
Edit `app/Providers/Filament/AdminPanelProvider.php`:

```php
use BezhanSalleh\FilamentShield\FilamentShieldPlugin;

public function panel(Panel $panel): Panel
{
    return $panel
        // ... existing config ...
        ->plugins([
            FilamentShieldPlugin::make(),
        ]);
}
```

### Step 5: Setup Shield
```bash
php artisan shield:setup
```
This will:
- Create super_admin role
- Generate permissions for existing resources
- Prompt to create super admin user

### Step 6: Add HasPanelShield Trait to User
Edit `app/Domain/User/Models/User.php`:

```php
use BezhanSalleh\FilamentShield\Traits\HasPanelShield;

class User extends Authenticatable implements FilamentUser
{
    use HasApiTokens;
    use HasFactory;
    use HasPanelShield;  // Replaces canAccessPanel logic
    use HasRoles;
    use HasSlug;
    use Notifiable;

    // Remove canAccessPanel() method - HasPanelShield handles it
}
```

### Step 7: Update DatabaseSeeder for Super Admin
Edit `database/seeders/DatabaseSeeder.php`:

```php
use Spatie\Permission\Models\Role;

public function run(): void
{
    // Create super_admin role if not exists
    $superAdminRole = Role::firstOrCreate(['name' => 'super_admin']);

    // Create admin user with super_admin role
    $admin = User::firstOrCreate(
        ['email' => 'admin@example.com'],
        [
            'name' => 'Admin',
            'password' => bcrypt('password'),
        ]
    );
    $admin->assignRole($superAdminRole);
}
```

### Step 8: Generate Permissions
```bash
php artisan shield:generate --all
```

## Todo List
- [ ] Install Shield plugin via composer
- [ ] Publish and configure shield config
- [ ] Register plugin in AdminPanelProvider
- [ ] Run `shield:setup` command
- [ ] Add HasPanelShield trait to User model
- [ ] Update database seeder for super admin
- [ ] Generate permissions with `shield:generate --all`
- [ ] Test role management in admin panel

## Success Criteria
- [ ] Shield RoleResource visible in admin sidebar
- [ ] Super admin can manage roles/permissions
- [ ] Permissions auto-generated for resources
- [ ] Non-super admin users respect permissions

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Conflict with existing permissions | Medium | Shield uses same spatie tables |
| Gate interference | Low | Configure `intercept_gate` properly |

## Security Considerations
- Super admin bypasses all permission checks (by design)
- Regular admins need explicit permissions per resource
- Shield gates integrate with Laravel's authorization

## Next Steps
→ Phase 03: Manga Domain Resources
